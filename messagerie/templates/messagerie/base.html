<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>{% block title %}Messages{% endblock %} - StudyConnect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        /* === NAVBAR RESPONSIVE UNIFIÉ === */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            height: 70px;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }
        
        .nav-center {
            display: flex;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-center a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-center a:hover, .nav-center a.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
        }
        
        .nav-text {
            display: inline;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            padding: 2px 6px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* === MENU UTILISATEUR === */
        .user-menu {
            position: relative;
        }
        
        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .user-menu-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
            border: 2px solid rgba(102, 126, 234, 0.2);
            font-size: 0.9rem;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            backdrop-filter: blur(10px);
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            border: 1px solid rgba(255,255,255,0.2);
            margin-top: 0.5rem;
        }
        
        .user-menu-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f3f4;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .user-menu-info h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
        }
        
        .user-menu-info p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .user-menu-body {
            padding: 0.5rem 0;
        }
        
        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .user-menu-item:hover {
            background: rgba(102, 126, 234, 0.05);
            color: #667eea;
            transform: translateX(5px);
        }
        
        .user-menu-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .user-menu-item.danger {
            color: #ff4757;
        }
        
        .user-menu-item.danger:hover {
            background: rgba(255, 71, 87, 0.05);
            color: #ff4757;
        }
        
        .user-menu-divider {
            height: 1px;
            background: #f1f3f4;
            margin: 0.5rem 0;
        }
        
        /* === OVERLAY POUR FERMER LE MENU === */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* === CHAT CONTAINER === */
        .chat-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            height: calc(100vh - 140px);
            display: flex;
            gap: 1rem;
        }
        
        .conversations-sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .search-box {
            padding: 1rem;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            transition: all 0.3s ease;
            font-size: 16px; /* Évite le zoom sur iOS */
        }
        
        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .conversation-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }
        
        .conversation-item:hover {
            background: #f8f9fa;
        }
        
        .conversation-item.active {
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-left: 4px solid #667eea;
        }
        
        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }
        
        .conversation-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: #2ed573;
            border: 2px solid white;
            border-radius: 50%;
        }
        
        .conversation-info {
            flex: 1;
            min-width: 0;
        }
        
        .conversation-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .conversation-preview {
            font-size: 0.9rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
            flex-shrink: 0;
        }
        
        .conversation-time {
            font-size: 0.8rem;
            color: #999;
        }
        
        .unread-badge {
            background: #ff4757;
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            padding: 2px 6px;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-main {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .mobile-back-btn {
            display: none;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .mobile-back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            overflow: hidden;
        }
        
        .chat-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-user-info h4 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .chat-user-info p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .chat-actions {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .messages-container {
            flex: 1;
            padding: 1rem;
            /* MODIFIER CETTE LIGNE : */
            padding-bottom: 120px; /* Espace pour l'input fixe */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 70%;
            animation: fadeInUp 0.3s ease;
        }
        
        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-bubble {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.sent .message-bubble {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: #999;
            margin-top: 0.25rem;
            text-align: right;
        }
        
        .message.sent .message-time {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .message-input-container {
            padding: 1.5rem;
            border-top: 1px solid #f1f3f4;
            background: white;
            /* AJOUTER CES LIGNES : */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .message-input-form {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .message-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .message-input {
            width: 100%;
            min-height: 45px;
            max-height: 120px;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            resize: none;
            outline: none;
            font-family: inherit;
            transition: all 0.3s ease;
            font-size: 16px; /* Évite le zoom sur iOS */
        }
        
        .message-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .emoji-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .emoji-btn:hover {
            background: #f8f9fa;
        }
        
        .file-input-btn {
            background: #6c757d;
            border: none;
            color: white;
            padding: 0.75rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-input-btn:hover {
            background: #5a6268;
            transform: scale(1.1);
        }
        
        .send-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 0.75rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
        }
        
        .empty-chat i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .filter-tabs {
            display: flex;
            padding: 1rem;
            border-bottom: 1px solid #f1f3f4;
            gap: 0.5rem;
        }
        
        .filter-tab {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: none;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .filter-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .toast {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
            /* MODIFIER CES LIGNES : */
            background: #28a745; /* Par défaut vert */
            border: none; /* Enlever les bordures blanches */
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }
        .toast-info { background: #17a2b8; }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        
        /* === ANIMATIONS === */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        
        /* === CLASSES UTILITAIRES === */
        .mobile-hidden { display: block; }
        .desktop-hidden { display: none; }
        
        /* === RESPONSIVE MOBILE === */
        @media (max-width: 768px) {
            body {
                margin: 0;
                padding: 0;
                overflow-x: hidden;
            }
            
            /* Navbar mobile - icônes seulement */
            .navbar {
                position: fixed;
                top: 0;
                width: 100%;
                z-index: 1000;
                padding: 0.5rem 0;
                height: 60px;
            }
            
            .nav-container {
                padding: 0 1rem;
            }
            
            .logo {
                font-size: 1.4rem;
            }
            
            .nav-center {
                gap: 0.5rem;
            }
            
            .nav-center a {
                font-size: 1.2rem;
                padding: 0.5rem;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .nav-text {
                display: none;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.8rem;
            }
            
            .user-menu-dropdown {
                right: -1rem;
                min-width: 260px;
                max-width: calc(100vw - 2rem);
            }
            
            .user-menu-header {
                padding: 1rem;
            }
            
            .user-menu-info h4 {
                font-size: 1rem;
            }
            
            .user-menu-info p {
                font-size: 0.85rem;
            }
            
            .user-menu-item {
                padding: 0.75rem 1rem;
            }
            
            /* Chat container mobile */
            .chat-container {
                margin: 0;
                padding: 0;
                height: 100vh;
                gap: 0;
                flex-direction: column;
                padding-top: 60px;
            }
            
            /* Sidebar mobile */
            .conversations-sidebar {
                width: 100%;
                height: calc(100vh - 60px);
                border-radius: 0;
                position: relative;
                z-index: 10;
            }
            
            .sidebar-header {
                padding: 1rem;
            }
            
            .sidebar-header h3 {
                font-size: 1.2rem;
            }
            
            /* Chat main mobile */
            .chat-main {
                width: 100%;
                height: calc(100vh - 60px);
                border-radius: 0;
                position: fixed;
                top: 60px;
                left: 0;
                z-index: 20;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                will-change: transform;
            }
            
            .chat-main.active {
                transform: translateX(0);
            }
            
            .mobile-back-btn {
                display: flex;
            }
            
            .chat-actions {
                display: none;
            }
            
            .chat-header {
                padding: 1rem;
                justify-content: space-between;
            }
            
            /* Messages mobile */
            .message {
                max-width: 85%;
            }
            
            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            .message-bubble {
                max-width: 280px;
                word-wrap: break-word;
            }
            
            .messages-container {
                padding-bottom: 140px;
            }
            
            .message-input-container {
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
            
            .message-input {
                font-size: 16px !important; /* Évite le zoom sur iOS */
            }
            
            /* Conversations mobile */
            .conversation-item {
                padding: 1rem;
                border-radius: 0;
                border-bottom: 1px solid #f8f9fa;
            }
            
            .conversation-name {
                font-size: 1rem;
                font-weight: 600;
            }
            
            .conversation-preview {
                font-size: 0.9rem;
                margin-top: 0.25rem;
            }
            
            .conversation-time {
                font-size: 0.8rem;
            }
            
            /* Utilitaires mobile */
            .mobile-hidden {
                display: none;
            }
            
            .desktop-hidden {
                display: block;
            }
            
            /* Toast mobile */
            .toast {
                top: 70px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            /* Optimisations scroll mobile */
            .conversations-list,
            .messages-container {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* Loading mobile */
            .loading-conversations {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 200px;
                color: #666;
            }
            
            .loading-conversations::before {
                content: '';
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 10px;
            }
            
            /* Safe area pour iPhone X+ */
            @supports (padding: max(0px)) {
                .chat-container {
                    padding-top: max(60px, env(safe-area-inset-top));
                }
                
                .message-input-container {
                    padding-bottom: max(1rem, env(safe-area-inset-bottom));
                }
                
                .navbar {
                    height: max(60px, env(safe-area-inset-top) + 60px);
                    padding-top: env(safe-area-inset-top);
                }
            }
        }
        
        /* === TABLET === */
        @media (min-width: 769px) and (max-width: 1024px) {
            .chat-container {
                padding: 0 1rem;
            }
            
            .conversations-sidebar {
                width: 320px;
            }
            
            .message {
                max-width: 80%;
            }
        }
        
        /* === DESKTOP === */
        @media (min-width: 1025px) {
            .mobile-back-btn {
                display: none !important;
            }
            
            .chat-main {
                position: relative !important;
                transform: none !important;
            }
        }
        
        /* === AMÉLIORATIONS POUR LA CONNECTIVITÉ === */
        .offline-indicator {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4757;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0 0 10px 10px;
            font-size: 0.9rem;
            z-index: 2000;
            animation: slideInDown 0.3s ease;
        }
        
        @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-100%); }
            to { transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="{% url 'relations:page' %}" class="logo">
                <i class="fas fa-graduation-cap"></i> 
                <span class="nav-text">AESConnect</span>
            </a>
            
            <ul class="nav-center">
                <li>
                    <a href="{% url 'relations:page' %}">
                        <i class="fas fa-users"></i> 
                        <span class="nav-text">Relations</span>
                        {% if notifications_non_lues > 0 %}
                            <span class="notification-badge">{{ notifications_non_lues }}</span>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="{% url 'messagerie:conversations' %}" 
                       {% if request.resolver_match.url_name in 'conversations,chat' %}class="active"{% endif %}>
                        <i class="fas fa-comments"></i> 
                        <span class="nav-text">Messages</span>
                        {% if total_unread > 0 %}
                            <span class="notification-badge">{{ total_unread }}</span>
                        {% endif %}
                    </a>
                </li>
                <li>
                    <a href="{% url 'relations:notifications' %}">
                        <i class="fas fa-bell"></i> 
                        <span class="nav-text">Notifications</span>
                    </a>
                </li>
            </ul>
            
            <!-- Menu utilisateur -->
            {% if user.is_authenticated %}
            <div class="user-menu">
                <button class="user-menu-toggle" onclick="toggleUserMenu()">
                    <div class="user-avatar">
                        {% if user.etudiant.photo %}
                            <img src="{{ user.etudiant.photo.url }}" alt="Avatar">
                        {% else %}
                            {{ user.etudiant.prenom|first }}{{ user.etudiant.nom|first }}
                        {% endif %}
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.8rem; margin-left: 0.25rem; color: #667eea;"></i>
                </button>
                
                <div class="user-menu-dropdown" id="userMenuDropdown">
                    <div class="user-menu-header">
                        <div class="user-menu-info">
                            <h4>{{ user.etudiant.get_full_name }}</h4>
                            <p>{{ user.email }}</p>
                        </div>
                    </div>
                    
                    <div class="user-menu-body">
                        <a href="{% url 'accounts:profile' %}" class="user-menu-item">
                            <i class="fas fa-user"></i>
                            <span>Mon profil</span>
                        </a>
                        
                        <a href="{% url 'accounts:edit_profile' %}" class="user-menu-item">
                            <i class="fas fa-edit"></i>
                            <span>Modifier le profil</span>
                        </a>
                        
                        <div class="user-menu-divider"></div>
                        
                        <a href="{% url 'relations:statistiques' %}" class="user-menu-item">
                            <i class="fas fa-chart-bar"></i>
                            <span>Statistiques</span>
                        </a>
                        
                        <a href="{% url 'relations:notifications' %}" class="user-menu-item">
                            <i class="fas fa-bell"></i>
                            <span>Notifications</span>
                            {% if notifications_non_lues > 0 %}
                                <span class="notification-badge" style="margin-left: auto;">{{ notifications_non_lues }}</span>
                            {% endif %}
                        </a>
                        
                        <div class="user-menu-divider"></div>
                        
                        <a href="{% url 'accounts:change_password' %}" class="user-menu-item">
                            <i class="fas fa-lock"></i>
                            <span>Changer le mot de passe</span>
                        </a>
                        
                        <button onclick="showToast('Fonctionnalité bientôt disponible', 'info')" class="user-menu-item">
                            <i class="fas fa-download"></i>
                            <span>Télécharger mes données</span>
                        </button>
                        
                        <div class="user-menu-divider"></div>
                        
                        <a href="{% url 'accounts:logout' %}" class="user-menu-item danger">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Se déconnecter</span>
                        </a>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="user-menu">
                <button class="user-menu-toggle" onclick="toggleUserMenu()">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.8rem; margin-left: 0.25rem; color: #667eea;"></i>
                </button>
                
                <div class="user-menu-dropdown" id="userMenuDropdown">
                    <div class="user-menu-body">
                        <a href="{% url 'accounts:login' %}" class="user-menu-item">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Se connecter</span>
                        </a>
                        
                        <a href="{% url 'accounts:register' %}" class="user-menu-item">
                            <i class="fas fa-user-plus"></i>
                            <span>S'inscrire</span>
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </nav>

    <!-- Overlay pour fermer le menu -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeUserMenu()"></div>

    <!-- Indicateur de connexion -->
    <div id="offlineIndicator" class="offline-indicator" style="display: none;">
        <i class="fas fa-wifi"></i> Connexion perdue - Reconnexion en cours...
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="toast toast-{{ message.tags }} animate__animated animate__fadeInRight">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% block content %}{% endblock %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // Configuration CSRF
        const csrfToken = '{{ csrf_token }}';
        
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrfToken);
                }
            }
        });

        // Variables globales pour la navigation mobile
        let isMobile = window.innerWidth <= 768;
        let currentView = 'conversations'; // 'conversations' ou 'chat'
        let isOnline = navigator.onLine;
        let consecutiveErrors = 0;
        let userMenuOpen = false;

        // Gestion du menu utilisateur
        function toggleUserMenu() {
            const dropdown = document.getElementById('userMenuDropdown');
            const overlay = document.getElementById('menuOverlay');
            
            if (userMenuOpen) {
                closeUserMenu();
            } else {
                dropdown.classList.add('active');
                overlay.classList.add('active');
                userMenuOpen = true;
            }
        }

        function closeUserMenu() {
            const dropdown = document.getElementById('userMenuDropdown');
            const overlay = document.getElementById('menuOverlay');
            
            dropdown.classList.remove('active');
            overlay.classList.remove('active');
            userMenuOpen = false;
        }

        // Fermer le menu en cliquant en dehors
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            if (!userMenu.contains(event.target) && userMenuOpen) {
                closeUserMenu();
            }
        });

        // Gestion du clavier (ESC pour fermer le menu)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && userMenuOpen) {
                closeUserMenu();
            }
        });

        // Détecter les changements de taille d'écran
        window.addEventListener('resize', function() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            
            if (wasMobile !== isMobile) {
                handleResponsiveChange();
                if (userMenuOpen) closeUserMenu();
            }
        });

        // Gestion des changements responsive
        function handleResponsiveChange() {
            if (!isMobile) {
                // Desktop : afficher les deux panels
                $('.chat-main').removeClass('active slide-in slide-out');
                $('.conversations-sidebar').show();
            } else {
                // Mobile : logique de navigation
                if (currentView === 'chat') {
                    showChatView();
                } else {
                    showConversationsView();
                }
            }
        }

        // Afficher la vue des conversations (mobile)
        function showConversationsView() {
            if (!isMobile) return;
            
            currentView = 'conversations';
            $('.conversations-sidebar').show();
            $('.chat-main').removeClass('active').addClass('slide-out');
            
            setTimeout(() => {
                $('.chat-main').removeClass('slide-out');
            }, 300);
        }

        // Afficher la vue de chat (mobile)
        function showChatView() {
            if (!isMobile) return;
            
            currentView = 'chat';
            $('.chat-main').addClass('active slide-in');
            
            setTimeout(() => {
                $('.chat-main').removeClass('slide-in');
            }, 300);
        }

        // Retour aux conversations (mobile)
        function goBackToConversations() {
            if (isMobile) {
                showConversationsView();
                // Changer l'URL sans recharger
                if (history.pushState) {
                    history.pushState(null, null, '/messagerie/');
                }
            }
        }

        // Gestion des clics sur les conversations
        function handleConversationClick(conversationId, event) {
            if (isMobile) {
                event.preventDefault();
                
                // Changer l'URL et afficher le chat
                if (history.pushState) {
                    history.pushState(null, null, `/messagerie/chat/${conversationId}/`);
                }
                showChatView();
                
                // Rediriger après l'animation
                setTimeout(() => {
                    window.location.href = `/messagerie/chat/${conversationId}/`;
                }, 150);
            }
            // Sur desktop, laisser le comportement normal
        }

        // Gestion du bouton retour du navigateur
        window.addEventListener('popstate', function(event) {
            if (isMobile && currentView === 'chat') {
                goBackToConversations();
            }
        });

        // Gestion de la connectivité
        window.addEventListener('online', function() {
            isOnline = true;
            consecutiveErrors = 0;
            $('#offlineIndicator').fadeOut();
            showToast('Connexion rétablie', 'success');
            
            // Relancer les fonctions qui dépendent de la connexion
            if (typeof startMessageRefresh === 'function') {
                startMessageRefresh();
            }
        });

        window.addEventListener('offline', function() {
            isOnline = false;
            $('#offlineIndicator').fadeIn();
            
            // Arrêter les fonctions qui dépendent de la connexion
            if (typeof stopMessageRefresh === 'function') {
                stopMessageRefresh();
            }
        });

        // Masquer les toasts automatiquement
        setTimeout(() => {
            $('.toast').fadeOut();
        }, 5000);

        // Fonction utilitaire pour afficher les toasts
        function showToast(message, type = 'info') {
            const toast = $(`<div class="toast toast-${type} animate__animated animate__fadeInRight">${message}</div>`);
            $('body').append(toast);
            setTimeout(() => toast.fadeOut(() => toast.remove()), 5000);
        }

        // Auto-resize textarea avec optimisation
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Formatage des timestamps optimisé
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);
            
            if (diffInHours < 24) {
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            }
        }

        // Gestion intelligente des erreurs AJAX
        function handleAjaxError(xhr, status, error, retryCallback = null) {
            consecutiveErrors++;
            
            let errorMsg = 'Erreur de connexion';
            if (status === 'timeout') {
                errorMsg = 'Délai d\'attente dépassé';
            } else if (xhr.status === 403) {
                errorMsg = 'Action non autorisée';
            } else if (xhr.status === 404) {
                errorMsg = 'Ressource non trouvée';
            } else if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }

            showToast(errorMsg, 'error');

            // Retry automatique pour certains types d'erreurs
            if (retryCallback && consecutiveErrors < 3 && (status === 'timeout' || xhr.status >= 500)) {
                setTimeout(() => {
                    console.log(`Tentative de retry ${consecutiveErrors}/3`);
                    retryCallback();
                }, Math.pow(2, consecutiveErrors) * 1000); // Backoff exponentiel
            }
        }

        // Optimisation pour les appareils tactiles
        if ('ontouchstart' in window) {
            // Réduire les délais de hover sur tactile
            $('body').addClass('touch-device');
            
            // Améliorer le scroll momentum sur iOS
            $('.messages-container, .conversations-list').css({
                '-webkit-overflow-scrolling': 'touch',
                'scroll-behavior': 'smooth'
            });
        }

        // Détection de la qualité de connexion
        if ('connection' in navigator) {
            const connection = navigator.connection;
            
            function updateConnectionStatus() {
                const effectiveType = connection.effectiveType;
                if (effectiveType === 'slow-2g' || effectiveType === '2g') {
                    // Connexion lente : réduire la fréquence des requêtes
                    console.log('Connexion lente détectée, optimisation activée');
                    window.slowConnection = true;
                } else {
                    window.slowConnection = false;
                }
            }
            
            connection.addEventListener('change', updateConnectionStatus);
            updateConnectionStatus();
        }

        // Initialiser la vue mobile au chargement
        $(document).ready(function() {
            if (isMobile) {
                const path = window.location.pathname;
                if (path.includes('/chat/')) {
                    currentView = 'chat';
                    showChatView();
                } else {
                    currentView = 'conversations';
                    showConversationsView();
                }
            }
            
            // Optimisations pour mobile
            if (isMobile) {
                // Désactiver le zoom sur les inputs
                $('input, textarea').attr('autocomplete', 'off');
                
                // Améliorer les performances sur mobile
                $('body').addClass('mobile-optimized');
                
                // Gérer l'orientation
                window.addEventListener('orientationchange', function() {
                    setTimeout(() => {
                        handleResponsiveChange();
                        if (typeof scrollToBottom === 'function') {
                            scrollToBottom();
                        }
                        // Forcer le recalcul de la hauteur viewport
                        if (window.visualViewport) {
                            document.documentElement.style.height = window.visualViewport.height + 'px';
                        }
                    }, 100);
                });
                
                // Gérer le clavier virtuel sur mobile
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', () => {
                        const viewport = window.visualViewport;
                        document.documentElement.style.height = viewport.height + 'px';
                    });
                }
            }
            
            // Initialiser l'état de connexion
            if (!navigator.onLine) {
                $('#offlineIndicator').show();
                isOnline = false;
            }
        });

        // Performance monitoring simple
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    if (perfData && perfData.loadEventEnd > 5000) {
                        console.log('Chargement lent détecté, considérer les optimisations');
                    }
                }, 1000);
            });
        }

        // Gestion mémoire pour éviter les fuites
        window.addEventListener('beforeunload', function() {
            // Nettoyer les intervalles
            if (typeof stopMessageRefresh === 'function') {
                stopMessageRefresh();
            }
            
            // Nettoyer les event listeners
            $(document).off();
            $(window).off('resize orientationchange');
        });

        // Précharger les ressources critiques si supporté
        if ('requestIdleCallback' in window) {
            requestIdleCallback(function() {
                // Précharger les icônes ou autres ressources non critiques
                const linkPrefetch = document.createElement('link');
                linkPrefetch.rel = 'prefetch';
                linkPrefetch.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/webfonts/fa-solid-900.woff2';
                document.head.appendChild(linkPrefetch);
            });
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>